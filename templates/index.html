<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gerenciador de Festas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- jsPDF e jsPDF-AutoTable (para exportar PDF pelo frontend, se preferir essa abordagem) -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script> -->

</head>

<body>
    <h1>Gerenciador de Convidados da Festa</h1>

    <div style="text-align: center; margin-bottom: 20px;">
        <a href="{{ url_for('scanner_page') }}" class="button scanner-page-button">Abrir Página de Check-in</a>
    </div>

    <div class="container">
        <!-- Seção de Estatísticas -->
        <div class="section stats-section">
            <h2>Estatísticas da Festa</h2>
            <div class="stats-overview">
                <p>Total de Convidados: <strong id="statsTotalInvited">-</strong></p>
                <p>Entraram na Festa: <strong id="statsEnteredCount">-</strong></p>
                <p>Ainda Não Entraram: <strong id="statsNotEnteredCount">-</strong></p>
                <p>Comparecimento: <strong id="statsPercentageEntered">- %</strong></p>
            </div>
            <div class="chart-container"
                style="position: relative; height:auto; max-height:300px; width:100%; max-width:300px; margin: 20px auto;">
                <canvas id="attendanceChart"></canvas>
            </div>
            <div style="text-align:center; margin-top: 10px;">
                <button onclick="fetchStats()">Atualizar Estatísticas</button>
            </div>
        </div>

        <!-- Adicionar Convidado -->
        <div class="section add-guest-section">
            <h2>Adicionar Convidado</h2>
            <form id="addGuestForm">
                <input type="text" id="guestName" placeholder="Nome do Convidado" required>
                <button type="submit">Adicionar e Gerar QR Code</button>
            </form>
            <div id="newQrCodeArea">
                <p id="guestAddedInfo"></p>
                <img id="newGuestQrImage" src="" alt="QR Code do Novo Convidado"
                    style="display:none; max-width: 150px; margin-top: 10px;">
                <a id="downloadQrLink" href="#" download style="display:none; margin-top: 5px; display: block;">Baixar
                    QR Code</a>
            </div>
        </div>

        <!-- Lista de Convidados -->
        <div class="section guest-list-section">
            <h2>Lista de Convidados</h2>
            <div class="guest-list-controls">
                <input type="text" id="searchInput" placeholder="Buscar por nome...">
                <button onclick="fetchGuestsWithCurrentSearchTerm(true)">Atualizar Lista</button>
            </div>
             <!-- Botões de Exportação -->
            <div class="export-buttons" style="margin-top: 15px; margin-bottom: 10px; text-align: right;">
                <button onclick="exportGuests('csv')" class="button-export">Exportar para CSV</button>
                <button onclick="exportGuests('pdf')" class="button-export" style="margin-left: 10px;">Exportar para PDF</button>
            </div>
            <div class="table-responsive-wrapper">
                <table id="guestTable">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Hash (QR Data)</th>
                            <th>QR Code</th>
                            <th>Entrou?</th>
                            <th>Data Check-in</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="guestList"></tbody>
                </table>
            </div>
        </div>

        <!-- Scanner de QR Code na Index (Opcional) -->
        <div class="section scanner-section">
            <h2>Check-in Rápido (nesta página)</h2>
            <div id="qrReaderMessageContainer">
                <p>Clique em "Iniciar Scanner" para ativar a câmera.</p>
                <p><strong>Importante:</strong> HTTPS e permissão de câmera são necessários.</p>
            </div>
            <div id="qrScannerWrapper">
                <div id="qrReader"></div>
                <div id="scanOverlayFeedback" class="scan-overlay"></div>
            </div>
            <button id="startScanButton" onclick="startQrScanner()">Iniciar Scanner</button>
            <button id="stopScanButton" onclick="stopQrScanner()" style="display:none;">Parar Scanner</button>
            <p id="scanResultText"></p>
        </div>
    </div>

    <audio id="beepSound" src="{{ url_for('static', filename='beep.mp3') }}" preload="auto"></audio>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>

</html>