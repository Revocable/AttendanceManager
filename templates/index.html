<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QRPass - Sistema de Controle de Acesso</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#1e40af',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                    },
                    backdropBlur: {
                        'xs': '2px',
                        'sm': '4px',
                        'md': '8px',
                        'lg': '12px',
                        'xl': '16px',
                        '2xl': '24px',
                        '3xl': '40px',
                    }
                }
            }
        }
    </script>
    <style>
        .glass-effect {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark .glass-effect {
            backdrop-filter: blur(20px);
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-card {
            backdrop-filter: blur(16px);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .dark .glass-card {
            backdrop-filter: blur(16px);
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-header {
            backdrop-filter: blur(24px);
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark .glass-header {
            backdrop-filter: blur(24px);
            background: rgba(0, 0, 0, 0.6);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            transition: all 0.3s ease-in-out;
            pointer-events: none;
            z-index: 10;
            padding: 1rem;
            backdrop-filter: blur(8px);
        }
        
        .scan-overlay.visible {
            opacity: 1;
        }
        
        .scan-overlay.success-bg {
            background-color: rgba(16, 185, 129, 0.9);
        }
        
        .scan-overlay.error-bg {
            background-color: rgba(239, 68, 68, 0.9);
        }
        
        .scan-overlay.warning-bg {
            background-color: rgba(245, 158, 11, 0.9);
        }
        
        .spinner {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 3px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.75s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hover-scale {
            transition: transform 0.2s ease;
        }
        
        .hover-scale:hover {
            transform: scale(1.02);
        }
        
        .mobile-card {
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .dark .mobile-card {
            backdrop-filter: blur(12px);
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .floating-blur {
            backdrop-filter: blur(32px);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .dark .floating-blur {
            backdrop-filter: blur(32px);
            background: rgba(0, 0, 0, 0.2);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .dark ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Guest list container with fixed height */
        .guest-list-container {
            height: 500px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .guest-list-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .guest-list-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }
        
        .guest-list-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        
        .dark .guest-list-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .dark .guest-list-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        .dark .skeleton {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
            background-size: 200% 100%;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Virtual scrolling optimization */
        .virtual-item {
            min-height: 60px;
            display: flex;
            align-items: center;
        }
        
        .virtual-spacer {
            pointer-events: none;
        }
        
        /* Logo styling */
        .logo-container {
            display: flex;
            align-items: center;
            space-x: 3;
        }
        
        .logo-image {
            height: 48px;
            width: auto;
            filter: brightness(0) invert(1);
            transition: all 0.3s ease;
        }
        
        .dark .logo-image {
            filter: brightness(0) invert(1);
        }
        
        .light .logo-image {
            filter: brightness(0);
        }
        
        @media (max-width: 640px) {
            .logo-image {
                height: 40px;
            }
        }

        /* Mobile card improvements */
        .mobile-guest-card {
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 1rem;
            border-radius: 0.75rem;
            padding: 1rem;
            width: 100%;
            box-sizing: border-box;
        }
        
        .dark .mobile-guest-card {
            backdrop-filter: blur(12px);
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .mobile-action-btn {
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        .mobile-qr-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 0.75rem 0;
        }

        .mobile-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin: 0.75rem 0;
            font-size: 0.875rem;
        }

        @media (max-width: 480px) {
            .mobile-actions-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .mobile-action-btn {
                padding: 0.75rem;
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 dark:from-gray-900 dark:via-blue-900 dark:to-indigo-900 min-h-screen transition-all duration-300">
    <!-- Animated Background -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute -top-40 -right-40 w-80 h-80 bg-purple-300 dark:bg-purple-600 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-xl opacity-70 animate-pulse"></div>
        <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-blue-300 dark:bg-blue-600 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-xl opacity-70 animate-pulse animation-delay-2000"></div>
        <div class="absolute top-40 left-40 w-80 h-80 bg-indigo-300 dark:bg-indigo-600 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-xl opacity-70 animate-pulse animation-delay-4000"></div>
    </div>

    <!-- Header -->
    <header class="glass-header sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="logo-container">
                    <img src="{{ url_for('static', filename='logo.png') }}" alt="QRPass Logo" class="logo-image mr-4">
                    <div>
                        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">QRPass</h1>
                        <p class="text-gray-600 dark:text-gray-300">Sistema de controle de acesso</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Dark Mode Toggle -->
                    <button onclick="toggleDarkMode()" 
                            class="floating-blur text-gray-700 dark:text-gray-300 p-3 rounded-xl hover:shadow-lg transition-all duration-200 hover-scale">
                        <i class="fas fa-moon dark:hidden text-lg"></i>
                        <i class="fas fa-sun hidden dark:inline text-lg"></i>
                    </button>
                    <a href="{{ url_for('scanner_page') }}" 
                       class="bg-gradient-to-r from-primary to-secondary text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg transition-all duration-200 hover-scale flex items-center space-x-2">
                        <i class="fas fa-qrcode"></i>
                        <span class="hidden sm:inline">Página de Check-in</span>
                        <span class="sm:hidden">Check-in</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 relative z-10">
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            <!-- Statistics Section -->
            <div class="xl:col-span-1">
                <div class="glass-card rounded-2xl shadow-2xl p-6 hover-scale fade-in">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-chart-pie text-primary mr-3"></i>
                            Estatísticas
                        </h2>
                        <button onclick="fetchStats()" 
                                class="floating-blur text-primary hover:text-secondary transition-colors p-2 rounded-lg hover:shadow-md">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-4 mb-6">
                        <div class="glass-effect p-4 rounded-xl">
                            <div class="text-2xl font-bold text-primary" id="statsTotalInvited">-</div>
                            <div class="text-sm text-gray-600 dark:text-gray-300">Total Convidados</div>
                        </div>
                        <div class="glass-effect p-4 rounded-xl">
                            <div class="text-2xl font-bold text-success" id="statsEnteredCount">-</div>
                            <div class="text-sm text-gray-600 dark:text-gray-300">Entraram</div>
                        </div>
                        <div class="glass-effect p-4 rounded-xl">
                            <div class="text-2xl font-bold text-danger" id="statsNotEnteredCount">-</div>
                            <div class="text-sm text-gray-600 dark:text-gray-300">Não Entraram</div>
                        </div>
                        <div class="glass-effect p-4 rounded-xl">
                            <div class="text-2xl font-bold text-purple-600" id="statsPercentageEntered">-%</div>
                            <div class="text-sm text-gray-600 dark:text-gray-300">Comparecimento</div>
                        </div>
                    </div>
                    
                    <div class="relative h-64 glass-effect rounded-xl p-4">
                        <canvas id="attendanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="xl:col-span-3 space-y-8">
                <!-- Add Guest Section -->
                <div class="glass-card rounded-2xl shadow-2xl p-6 hover-scale fade-in">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                        <i class="fas fa-user-plus text-success mr-3"></i>
                        Adicionar Convidado
                    </h2>
                    
                    <form id="addGuestForm" class="space-y-4">
                        <div class="flex flex-col sm:flex-row gap-4">
                            <div class="flex-1">
                                <input type="text" 
                                       id="guestName" 
                                       placeholder="Nome do Convidado" 
                                       required
                                       class="w-full px-4 py-3 glass-effect rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                            </div>
                            <button type="submit" 
                                    class="bg-gradient-to-r from-success to-green-600 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg transition-all duration-200 hover-scale flex items-center justify-center space-x-2">
                                <i class="fas fa-plus"></i>
                                <span>Adicionar</span>
                            </button>
                        </div>
                    </form>
                    
                    <div id="newQrCodeArea" class="mt-6 p-4 glass-effect rounded-xl text-center hidden">
                        <p id="guestAddedInfo" class="font-semibold mb-4"></p>
                        <img id="newGuestQrImage" src="/placeholder.svg" alt="QR Code" class="mx-auto mb-4 rounded-lg shadow-md" style="display:none; max-width: 150px;">
                        <a id="downloadQrLink" href="#" download class="inline-flex items-center space-x-2 bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition-colors" style="display:none;">
                            <i class="fas fa-download"></i>
                            <span>Baixar QR Code</span>
                        </a>
                    </div>
                </div>

                <!-- Guest List Section -->
                <div class="glass-card rounded-2xl shadow-2xl p-6 hover-scale fade-in">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-white flex items-center mb-4 lg:mb-0">
                            <i class="fas fa-users text-primary mr-3"></i>
                            Lista de Convidados
                            <span id="guestCount" class="ml-2 text-sm bg-primary text-white px-2 py-1 rounded-full">0</span>
                        </h2>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <button onclick="exportGuests('csv')" 
                                    class="bg-success text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center space-x-2">
                                <i class="fas fa-file-csv"></i>
                                <span>CSV</span>
                            </button>
                            <button onclick="exportGuests('pdf')" 
                                    class="bg-danger text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center space-x-2">
                                <i class="fas fa-file-pdf"></i>
                                <span>PDF</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4 mb-6">
                        <div class="flex-1 relative">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" 
                                   id="searchInput" 
                                   placeholder="Buscar por nome..." 
                                   class="w-full pl-10 pr-4 py-3 glass-effect rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                        </div>
                        <button onclick="fetchGuestsWithCurrentSearchTerm(true)" 
                                class="bg-primary text-white px-6 py-3 rounded-xl font-semibold hover:bg-secondary transition-colors flex items-center justify-center space-x-2">
                            <i class="fas fa-sync-alt"></i>
                            <span>Atualizar</span>
                        </button>
                    </div>
                    
                    <!-- Loading indicator -->
                    <div id="loadingIndicator" class="hidden text-center py-8">
                        <div class="inline-flex items-center space-x-2 text-gray-600 dark:text-gray-400">
                            <div class="spinner"></div>
                            <span>Carregando convidados...</span>
                        </div>
                    </div>
                    
                    <!-- Desktop Table with Fixed Height and Scroll -->
                    <div class="hidden lg:block">
                        <div class="glass-effect rounded-xl overflow-hidden">
                            <div class="guest-list-container">
                                <table class="w-full table-fixed min-w-[900px]">
                                    <thead class="bg-gray-50 dark:bg-gray-800/50 sticky top-0 z-10">
                                        <tr>
                                            <th class="px-4 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" style="width: 25%">Nome</th>
                                            <th class="px-4 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" style="width: 15%">Hash</th>
                                            <th class="px-4 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" style="width: 10%">QR Code</th>
                                            <th class="px-4 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" style="width: 15%">Status</th>
                                            <th class="px-4 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" style="width: 20%">Check-in</th>
                                            <th class="px-4 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" style="width: 15%">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="guestList" class="divide-y divide-gray-200 dark:divide-gray-700">
                                        <!-- Guest rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile Cards with Fixed Height and Scroll -->
                    <div class="lg:hidden">
                        <div class="guest-list-container" id="guestCardsList">
                            <!-- Guest cards will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div id="paginationControls" class="flex items-center justify-between mt-6 hidden">
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            Mostrando <span id="showingStart">0</span> a <span id="showingEnd">0</span> de <span id="totalGuests">0</span> convidados
                        </div>
                        <div class="flex space-x-2">
                            <button id="prevPage" onclick="changePage(-1)" 
                                    class="px-3 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span id="pageInfo" class="px-4 py-2 text-gray-700 dark:text-gray-300">Página 1</span>
                            <button id="nextPage" onclick="changePage(1)" 
                                    class="px-3 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- QR Scanner Section -->
                <div class="glass-card rounded-2xl shadow-2xl p-6 hover-scale fade-in">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                        <i class="fas fa-camera text-primary mr-3"></i>
                        Check-in Rápido
                    </h2>
                    
                    <div id="qrReaderMessageContainer" class="text-center mb-6">
                        <div class="glass-effect border border-blue-200 dark:border-blue-700 rounded-xl p-4">
                            <p class="text-blue-800 dark:text-blue-300 font-medium">Clique em "Iniciar Scanner" para ativar a câmera</p>
                            <p class="text-blue-600 dark:text-blue-400 text-sm mt-1">HTTPS e permissão de câmera são necessários</p>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <div id="qrScannerWrapper" class="relative inline-block rounded-2xl overflow-hidden border-4 border-primary shadow-2xl" style="display: none;">
                            <div id="qrReader" class="w-80 h-80"></div>
                            <div id="scanOverlayFeedback" class="scan-overlay"></div>
                        </div>
                        
                        <div class="mt-6 space-y-4">
                            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                                <button id="startScanButton" 
                                        onclick="startQrScanner()" 
                                        class="bg-gradient-to-r from-primary to-secondary text-white px-8 py-3 rounded-xl font-semibold hover:shadow-lg transition-all duration-200 hover-scale flex items-center justify-center space-x-2">
                                    <i class="fas fa-play"></i>
                                    <span>Iniciar Scanner</span>
                                </button>
                                <button id="stopScanButton" 
                                        onclick="stopQrScanner()" 
                                        style="display:none;" 
                                        class="bg-gray-600 text-white px-8 py-3 rounded-xl font-semibold hover:bg-gray-700 transition-colors flex items-center justify-center space-x-2">
                                    <i class="fas fa-stop"></i>
                                    <span>Parar Scanner</span>
                                </button>
                            </div>
                            
                            <div id="scanResultText" class="p-4 rounded-xl font-medium min-h-[3rem] flex items-center justify-center glass-effect"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <audio id="beepSound" src="{{ url_for('static', filename='beep.mp3') }}" preload="auto"></audio>

    <script>
        // --- Dark Mode Toggle ---
        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            
            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('darkMode', 'false');
            } else {
                html.classList.add('dark');
                localStorage.setItem('darkMode', 'true');
            }
            
            // Update logo filter based on theme
            updateLogoFilter();
        }

        function updateLogoFilter() {
            const logo = document.querySelector('.logo-image');
            const isDark = document.documentElement.classList.contains('dark');
            
            if (logo) {
                if (isDark) {
                    logo.style.filter = 'brightness(0) invert(1)'; // White logo for dark mode
                } else {
                    logo.style.filter = 'brightness(0)'; // Black logo for light mode
                }
            }
        }

        // Initialize dark mode from localStorage or default to dark
        document.addEventListener('DOMContentLoaded', () => {
            const savedMode = localStorage.getItem('darkMode');
            if (savedMode === null || savedMode === 'true') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            
            // Set initial logo filter
            updateLogoFilter();
        });

        // --- JavaScript Code ---
        const API_BASE_URL = '';
        let html5QrCode = null;
        let beepAudio = null;
        const OVERLAY_TIMEOUT_MS = 2500;
        let overlayTimeoutId = null;
        let lastScannedHash = null;
        let lastScanTime = 0;
        const SCAN_COOLDOWN_MS = 3000;
        const SEARCH_DEBOUNCE_MS = 300;
        let attendanceChartInstance = null;

        // Pagination and performance optimization
        let allGuests = [];
        let filteredGuests = [];
        let currentPage = 1;
        const ITEMS_PER_PAGE = 50;
        let isLoading = false;

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            const guestListElement = document.getElementById('guestList');
            const addGuestFormElement = document.getElementById('addGuestForm');
            const statsTotalInvitedElement = document.getElementById('statsTotalInvited');
            const searchInputElement = document.getElementById('searchInput');

            if (guestListElement || addGuestFormElement) {
                if (typeof fetchGuests === "function") {
                    fetchGuests();
                }
                if (typeof fetchStats === "function" && statsTotalInvitedElement) {
                     fetchStats();
                }
            }

            if (addGuestFormElement) {
                addGuestFormElement.addEventListener('submit', (event) => {
                    event.preventDefault(); 
                    addGuest();
                });
            }

            if (searchInputElement) {
                searchInputElement.addEventListener('input', debouncedHandleSearch);
            }

            const qrReaderElementId = "qrReader";
            const qrReaderElement = document.getElementById(qrReaderElementId);
            if (qrReaderElement) {
                html5QrCode = new Html5Qrcode(qrReaderElementId, { verbose: false });
            }

            beepAudio = document.getElementById('beepSound');
            if (beepAudio) {
                beepAudio.onerror = () => console.error("Erro ao carregar 'beep.mp3'.");
            }

            const newGuestQrImage = document.getElementById('newGuestQrImage');
            if (newGuestQrImage) newGuestQrImage.style.display = 'none';
            const downloadQrLink = document.getElementById('downloadQrLink');
            if (downloadQrLink) downloadQrLink.style.display = 'none';
            const guestAddedInfo = document.getElementById('guestAddedInfo');
            if (guestAddedInfo) guestAddedInfo.textContent = '';
        });

        // --- Performance Optimized Guest Functions ---
        function showLoading(show = true) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.classList.toggle('hidden', !show);
            }
        }

        function updateGuestCount(count) {
            const guestCountEl = document.getElementById('guestCount');
            if (guestCountEl) {
                guestCountEl.textContent = count;
            }
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredGuests.length / ITEMS_PER_PAGE);
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, filteredGuests.length);
            
            const paginationControls = document.getElementById('paginationControls');
            const showingStart = document.getElementById('showingStart');
            const showingEnd = document.getElementById('showingEnd');
            const totalGuests = document.getElementById('totalGuests');
            const pageInfo = document.getElementById('pageInfo');
            const prevPage = document.getElementById('prevPage');
            const nextPage = document.getElementById('nextPage');
            
            if (filteredGuests.length > ITEMS_PER_PAGE) {
                paginationControls.classList.remove('hidden');
                showingStart.textContent = startIndex + 1;
                showingEnd.textContent = endIndex;
                totalGuests.textContent = filteredGuests.length;
                pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
                
                prevPage.disabled = currentPage === 1;
                nextPage.disabled = currentPage === totalPages;
            } else {
                paginationControls.classList.add('hidden');
            }
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredGuests.length / ITEMS_PER_PAGE);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderCurrentPage();
                updatePagination();
            }
        }

        function renderCurrentPage() {
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, filteredGuests.length);
            const pageGuests = filteredGuests.slice(startIndex, endIndex);
            
            renderGuests(pageGuests);
        }

        function filterGuests(searchTerm = '') {
            if (!searchTerm.trim()) {
                filteredGuests = [...allGuests];
            } else {
                const term = searchTerm.toLowerCase();
                filteredGuests = allGuests.filter(guest => 
                    guest.name.toLowerCase().includes(term) ||
                    (guest.qr_hash && guest.qr_hash.toLowerCase().includes(term))
                );
            }
            
            currentPage = 1;
            updateGuestCount(filteredGuests.length);
            updatePagination();
            renderCurrentPage();
        }

        async function addGuest() {
            const nameInput = document.getElementById('guestName');
            if (!nameInput) { 
                console.warn("addGuest: #guestName não encontrado."); 
                return; 
            }
            
            const name = nameInput.value.trim();
            const guestAddedInfo = document.getElementById('guestAddedInfo');
            const newGuestQrImage = document.getElementById('newGuestQrImage');
            const downloadQrLink = document.getElementById('downloadQrLink');
            const qrCodeArea = document.getElementById('newQrCodeArea');

            // Reset UI
            if(guestAddedInfo) guestAddedInfo.textContent = '';
            if(newGuestQrImage) {
                newGuestQrImage.style.display = 'none'; 
                newGuestQrImage.src = '';
            }
            if(downloadQrLink) {
                downloadQrLink.style.display = 'none'; 
                downloadQrLink.href = '#';
            }
            if(qrCodeArea) qrCodeArea.classList.add('hidden');

            if (!name) { 
                alert('Nome do convidado é obrigatório.'); 
                return; 
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/guests`, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ name: name })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    if(guestAddedInfo) {
                        guestAddedInfo.textContent = `Erro: ${result.error || 'Falha ao adicionar.'}`;
                        guestAddedInfo.className = 'text-red-600 dark:text-red-400';
                    }
                    if(qrCodeArea) qrCodeArea.classList.remove('hidden');
                    return;
                }
                
                if(guestAddedInfo) {
                    guestAddedInfo.textContent = `Convidado "${result.name}" adicionado com sucesso!`;
                    guestAddedInfo.className = 'text-green-600 dark:text-green-400';
                }
                
                if (result.qr_image_url) {
                    const imageUrl = `${result.qr_image_url}?t=${new Date().getTime()}`;
                    if(newGuestQrImage) {
                        newGuestQrImage.src = imageUrl; 
                        newGuestQrImage.style.display = 'block';
                    }
                    if(downloadQrLink) {
                        downloadQrLink.href = imageUrl; 
                        downloadQrLink.download = `qrcode_${result.name.replace(/\s+/g, '_')}.png`; 
                        downloadQrLink.style.display = 'inline-flex';
                    }
                }
                
                if(qrCodeArea) qrCodeArea.classList.remove('hidden');
                nameInput.value = '';
                
                // Refresh guest list
                fetchGuests();
                if (document.getElementById('statsTotalInvited') && typeof fetchStats === "function") fetchStats();
                
            } catch (error) {
                console.error('Erro ao adicionar convidado:', error);
                if(guestAddedInfo) {
                    guestAddedInfo.textContent = 'Erro de rede ao adicionar.'; 
                    guestAddedInfo.className = 'text-red-600 dark:text-red-400';
                }
                if(qrCodeArea) qrCodeArea.classList.remove('hidden');
            }
        }

        async function fetchGuests(searchTerm = '') {
            if (isLoading) return;
            
            isLoading = true;
            showLoading(true);
            
            let apiUrl = `${API_BASE_URL}/api/guests`;
            
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    console.error('Erro ao buscar convidados:', response.statusText);
                    showErrorMessage('Erro ao carregar lista. Tente novamente.');
                    return;
                }
                
                allGuests = await response.json();
                
                // Apply current search filter
                const currentSearchTerm = document.getElementById('searchInput')?.value.trim() || searchTerm;
                filterGuests(currentSearchTerm);
                
            } catch (error) {
                console.error('Erro de rede ao buscar convidados:', error);
                showErrorMessage('Erro de rede. Verifique sua conexão.');
            } finally {
                isLoading = false;
                showLoading(false);
            }
        }

        function showErrorMessage(message) {
            const tbody = document.getElementById('guestList');
            const mobileContainer = document.getElementById('guestCardsList');
            
            if (tbody) tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">${message}</td></tr>`;
            if (mobileContainer) mobileContainer.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 py-8">${message}</div>`;
        }

        function renderGuests(guests) {
            const tbody = document.getElementById('guestList');
            const mobileContainer = document.getElementById('guestCardsList');
            
            if (tbody) tbody.innerHTML = '';
            if (mobileContainer) mobileContainer.innerHTML = '';

            if (guests.length === 0) {
                const message = document.getElementById('searchInput')?.value.trim() ?
                                'Nenhum convidado encontrado com este critério.' :
                                'Nenhum convidado cadastrado.';
                if (tbody) tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">${message}</td></tr>`;
                if (mobileContainer) mobileContainer.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 py-8">${message}</div>`;
                return;
            }

            // Use requestAnimationFrame for smooth rendering
            requestAnimationFrame(() => {
                guests.forEach((guest, index) => {
                    setTimeout(() => {
                        // Desktop Table Row
                        if (tbody) {
                            const row = tbody.insertRow();
                            row.className = 'hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors';
                            
                            // Name
                            const nameCell = row.insertCell();
                            nameCell.className = 'px-4 py-3 text-sm font-medium text-gray-900 dark:text-white truncate';
                            nameCell.style.width = '25%';
                            nameCell.textContent = guest.name;
                            nameCell.title = guest.name; // Tooltip for truncated names

                            // Hash
                            const hashCell = row.insertCell();
                            hashCell.className = 'px-4 py-3 text-sm text-gray-500 dark:text-gray-400 font-mono';
                            hashCell.style.width = '15%';
                            hashCell.textContent = guest.qr_hash ? guest.qr_hash.substring(0, 8) + '...' : 'N/A';

                            // QR Code
                            const qrCell = row.insertCell();
                            qrCell.className = 'px-4 py-3 text-sm text-gray-500 dark:text-gray-400 text-center';
                            qrCell.style.width = '10%';
                            if (guest.qr_image_url) {
                                const img = document.createElement('img'); 
                                img.src = `${guest.qr_image_url}?t=${new Date().getTime()}`;
                                img.alt = `QR ${guest.name}`; 
                                img.className = 'w-8 h-8 mx-auto cursor-pointer object-contain border border-gray-200 dark:border-gray-600 rounded hover:shadow-md transition-shadow';
                                img.onclick = () => window.open(img.src, '_blank'); 
                                qrCell.appendChild(img);
                            } else { 
                                qrCell.textContent = 'N/A'; 
                            }

                            // Status
                            const enteredCell = row.insertCell();
                            enteredCell.className = 'px-4 py-3 text-sm';
                            enteredCell.style.width = '15%';
                            if (guest.entered) {
                                enteredCell.innerHTML = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200"><i class="fas fa-check mr-1"></i>Entrou</span>';
                            } else {
                                enteredCell.innerHTML = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200"><i class="fas fa-times mr-1"></i>Não Entrou</span>';
                            }

                            // Check-in Time
                            const checkInTimeCell = row.insertCell();
                            checkInTimeCell.className = 'px-4 py-3 text-sm text-gray-500 dark:text-gray-400';
                            checkInTimeCell.style.width = '20%';
                            checkInTimeCell.textContent = guest.check_in_time ? guest.check_in_time : 'N/A';

                            // Actions
                            const actionsCell = row.insertCell();
                            actionsCell.className = 'px-4 py-3 text-sm font-medium';
                            actionsCell.style.width = '15%';
                            actionsCell.innerHTML = createActionButtons(guest);
                        }

                        // Mobile Card - FIXED LAYOUT
                        if (mobileContainer) {
                            const card = document.createElement('div');
                            card.className = 'mobile-guest-card';
                            
                            card.innerHTML = `
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-semibold text-gray-900 dark:text-white text-lg">${guest.name}</h3>
                                    ${guest.entered ? 
                                        '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200"><i class="fas fa-check mr-1"></i>Entrou</span>' :
                                        '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200"><i class="fas fa-times mr-1"></i>Não Entrou</span>'
                                    }
                                </div>
                                
                                <div class="mobile-info-grid">
                                    <div>
                                        <span class="text-gray-500 dark:text-gray-400 text-sm">Hash:</span>
                                        <div class="font-mono text-xs text-gray-700 dark:text-gray-300">${guest.qr_hash ? guest.qr_hash.substring(0, 12) + '...' : 'N/A'}</div>
                                    </div>
                                    <div>
                                        <span class="text-gray-500 dark:text-gray-400 text-sm">Check-in:</span>
                                        <div class="text-xs text-gray-700 dark:text-gray-300">${guest.check_in_time || 'N/A'}</div>
                                    </div>
                                </div>
                                
                                <div class="mobile-qr-section">
                                    <div class="flex-shrink-0">
                                        ${guest.qr_image_url ? 
                                            `<img src="${guest.qr_image_url}?t=${new Date().getTime()}" alt="QR ${guest.name}" class="w-16 h-16 cursor-pointer object-contain border border-gray-200 dark:border-gray-600 rounded-lg hover:shadow-md transition-shadow" onclick="window.open(this.src, '_blank')">` :
                                            '<div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center text-gray-400 text-xs">N/A</div>'
                                        }
                                    </div>
                                    <div class="flex-1 ml-4">
                                        <div class="mobile-actions-grid">
                                            <button onclick="editGuestNamePrompt('${guest.qr_hash}', '${guest.name.replace(/'/g, "\\'")}')" 
                                                    class="mobile-action-btn bg-yellow-500 text-white hover:bg-yellow-600">
                                                <i class="fas fa-edit"></i>
                                                <span>Editar</span>
                                            </button>
                                            <button onclick="toggleGuestEntry('${guest.qr_hash}')" 
                                                    class="mobile-action-btn ${guest.entered ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-500 hover:bg-green-600'} text-white">
                                                <i class="fas fa-${guest.entered ? 'user-minus' : 'user-check'}"></i>
                                                <span>${guest.entered ? 'Saída' : 'Entrada'}</span>
                                            </button>
                                            <button onclick="confirmDeleteGuest('${guest.qr_hash}', '${guest.name.replace(/'/g, "\\'")}')" 
                                                    class="mobile-action-btn bg-red-500 text-white hover:bg-red-600">
                                                <i class="fas fa-trash"></i>
                                                <span>Remover</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            mobileContainer.appendChild(card);
                        }
                    }, index * 10); // Stagger rendering for smoother performance
                });
            });
        }

        function createActionButtons(guest) {
            return `
                <div class="flex space-x-1">
                    <button onclick="editGuestNamePrompt('${guest.qr_hash}', '${guest.name}')" 
                            class="bg-yellow-500 text-white p-1 rounded text-xs hover:bg-yellow-600 transition-colors" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="toggleGuestEntry('${guest.qr_hash}')" 
                            class="${guest.entered ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-500 hover:bg-green-600'} text-white p-1 rounded text-xs transition-colors" 
                            title="${guest.entered ? 'Marcar Saída' : 'Marcar Entrada'}">
                        <i class="fas fa-${guest.entered ? 'user-minus' : 'user-check'}"></i>
                    </button>
                    <button onclick="confirmDeleteGuest('${guest.qr_hash}', '${guest.name}')" 
                            class="bg-red-500 text-white p-1 rounded text-xs hover:bg-red-600 transition-colors" title="Remover">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        async function editGuestNamePrompt(qrHash, currentName) {
            const newName = prompt("Digite o novo nome para o convidado:", currentName);
            if (newName === null) { return; }
            const trimmedNewName = newName.trim();
            if (!trimmedNewName) { alert("O nome não pode ser vazio."); return; }
            if (trimmedNewName === currentName) { return; }

            try {
                const response = await fetch(`${API_BASE_URL}/api/guests/${qrHash}/edit`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: trimmedNewName })
                });
                const result = await response.json();
                if (!response.ok) {
                    alert(`Erro ao editar: ${result.error || 'Erro desconhecido.'}`);
                } else {
                    alert(result.message || 'Nome atualizado com sucesso!');
                    fetchGuests();
                }
            } catch (error) {
                console.error('Erro de rede ao editar convidado:', error);
                alert('Erro de rede ao tentar editar o nome.');
            }
        }

        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value;
            filterGuests(searchTerm);
        }
        const debouncedHandleSearch = debounce(handleSearch, SEARCH_DEBOUNCE_MS);

        function fetchGuestsWithCurrentSearchTerm(manualRefresh = false) {
            if (manualRefresh) {
                fetchGuests();
            } else {
                const searchTerm = document.getElementById('searchInput').value;
                filterGuests(searchTerm);
            }
        }

        function confirmDeleteGuest(qrHash, guestName) { 
            if (confirm(`Tem certeza que deseja remover "${guestName}"?`)) { 
                deleteGuest(qrHash); 
            } 
        }

        async function deleteGuest(qrHash) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/guests/${qrHash}`, { method: 'DELETE' });
                const result = await response.json();
                if (!response.ok) { 
                    alert(`Erro ao remover: ${result.error || 'Erro.'}`); 
                    return; 
                }
                alert(result.message || 'Removido.');
                fetchGuests();
                if (document.getElementById('statsTotalInvited') && typeof fetchStats === "function") fetchStats();
            } catch (error) { 
                console.error('Erro de rede ao remover:', error); 
                alert('Erro de rede.'); 
            }
        }

        async function toggleGuestEntry(qrHash) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/guests/${qrHash}/toggle_entry`, { method: 'PUT' });
                const result = await response.json(); 
                if (!response.ok) { 
                    alert(`Erro: ${result.error}`); 
                    return; 
                }
                
                // Update local data for immediate UI feedback
                const guest = allGuests.find(g => g.qr_hash === qrHash);
                if (guest) {
                    guest.entered = !guest.entered;
                    guest.check_in_time = guest.entered ? new Date().toLocaleString() : null;
                    filterGuests(document.getElementById('searchInput').value);
                }
                
                if (document.getElementById('statsTotalInvited') && typeof fetchStats === "function") fetchStats();
            } catch (error) { 
                console.error('Erro ao alterar status:', error); 
            }
        }

        function exportGuests(format) {
            const searchTerm = document.getElementById('searchInput').value.trim();
            let exportUrl = `${API_BASE_URL}/api/guests/export/${format}`;
            if (searchTerm) { 
                exportUrl += `?search=${encodeURIComponent(searchTerm)}`; 
            }
            window.open(exportUrl, '_blank');
        }

        async function fetchStats() {
            const statsTotalInvitedEl = document.getElementById('statsTotalInvited');
            if (!statsTotalInvitedEl) { return; }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/stats`);
                if (!response.ok) {
                    statsTotalInvitedEl.textContent = 'Erro';
                    document.getElementById('statsEnteredCount').textContent = '-';
                    document.getElementById('statsNotEnteredCount').textContent = '-';
                    document.getElementById('statsPercentageEntered').textContent = '-%';
                    return;
                }
                
                const stats = await response.json();
                statsTotalInvitedEl.textContent = stats.total_invited;
                document.getElementById('statsEnteredCount').textContent = stats.entered_count;
                document.getElementById('statsNotEnteredCount').textContent = stats.not_entered_count;
                document.getElementById('statsPercentageEntered').textContent = stats.percentage_entered + "%";
                
                if (typeof updateAttendanceChart === "function") {
                     updateAttendanceChart(stats.entered_count, stats.not_entered_count);
                }
            } catch (error) {
                statsTotalInvitedEl.textContent = 'Erro de Rede'; 
                console.error("Erro de rede ao buscar estatísticas:", error);
            }
        }

        function updateAttendanceChart(entered, notEntered) {
            const ctx = document.getElementById('attendanceChart');
            if (!ctx) { return; }
            
            const isDark = document.documentElement.classList.contains('dark');
            
            const data = {
                labels: ['Entraram', 'Não Entraram'],
                datasets: [{
                    label: 'Comparecimento', 
                    data: [entered, notEntered],
                    backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(239, 68, 68, 0.8)'],
                    borderColor: ['rgba(16, 185, 129, 1)', 'rgba(239, 68, 68, 1)'],
                    borderWidth: 2, 
                    hoverOffset: 8
                }]
            };
            
            const configChart = {
                type: 'doughnut', 
                data: data,
                options: {
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                color: isDark ? '#e5e7eb' : '#374151'
                            }
                        },
                        title: { 
                            display: true, 
                            text: 'Distribuição de Comparecimento',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: isDark ? '#e5e7eb' : '#374151'
                        },
                        tooltip: { 
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || ''; 
                                    if (label) { label += ': '; }
                                    if (context.parsed !== null) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) + '%' : '0%';
                                        label += context.parsed + ' (' + percentage + ')';
                                    } 
                                    return label;
                                }
                            }
                        }
                    }
                }
            };
            
            if (attendanceChartInstance) {
                attendanceChartInstance.data.datasets[0].data = [entered, notEntered];
                attendanceChartInstance.options.plugins.legend.labels.color = isDark ? '#e5e7eb' : '#374151';
                attendanceChartInstance.options.plugins.title.color = isDark ? '#e5e7eb' : '#374151';
                attendanceChartInstance.update();
            } else {
                attendanceChartInstance = new Chart(ctx, configChart);
            }
        }

        // --- QR Scanner Functions ---
        function showOverlayFeedback(type, icon, message) {
            const overlay = document.getElementById('scanOverlayFeedback');
            const textFeedback = document.getElementById('scanResultText');
            
            if (overlayTimeoutId) { 
                clearTimeout(overlayTimeoutId); 
            }
            
            if (overlay) {
                overlay.innerHTML = `<div class="text-4xl mb-2">${icon}</div><div class="text-sm">${message}</div>`;
                overlay.className = 'scan-overlay visible';
                
                if (type === 'success') overlay.classList.add('success-bg');
                else if (type === 'error') overlay.classList.add('error-bg');
                else if (type === 'warning') overlay.classList.add('warning-bg');
                
                if (type !== 'processing') {
                    overlayTimeoutId = setTimeout(() => {
                        overlay.classList.remove('visible', 'success-bg', 'error-bg', 'warning-bg');
                    }, OVERLAY_TIMEOUT_MS);
                }
            }
            
            if(textFeedback) {
                textFeedback.textContent = (type === 'processing') ? `Processando QR...` : message;
                textFeedback.className = `p-4 rounded-xl font-medium min-h-[3rem] flex items-center justify-center glass-effect ${
                    type === 'success' ? 'text-green-800 dark:text-green-200' :
                    type === 'error' ? 'text-red-800 dark:text-red-200' :
                    type === 'warning' ? 'text-yellow-800 dark:text-yellow-200' :
                    'text-blue-800 dark:text-blue-200'
                }`;
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            const currentTime = Date.now();
            if (decodedText === lastScannedHash && (currentTime - lastScanTime) < SCAN_COOLDOWN_MS) { 
                return; 
            }
            
            showOverlayFeedback('processing', '<div class="spinner"></div>', `Processando...`);
            lastScannedHash = decodedText; 
            lastScanTime = currentTime;
            processScannedQr(decodedText);
        }

        function onScanFailure(error) { 
            // Silent fail for continuous scanning
        }

        async function processScannedQr(qrHash) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/guests/${qrHash}/enter`, { method: 'POST' });
                const result = await response.json();
                
                if (!response.ok) {
                     showOverlayFeedback('error', '✗', result.error || 'QR inválido/não encontrado.');
                } else {
                    let message = result.message;
                    if (result.is_new_entry === true) {
                        showOverlayFeedback('success', '✓', message);
                        if (beepAudio) { 
                            beepAudio.currentTime = 0; 
                            beepAudio.play().catch(e => console.error("Erro ao tocar beep:", e)); 
                        }
                    } else {
                        showOverlayFeedback('warning', 'ⓘ', message);
                    }
                    
                    // Update local data and refresh current view
                    fetchGuests();
                    if (document.getElementById('statsTotalInvited') && typeof fetchStats === "function") fetchStats();
                }
            } catch (error) {
                showOverlayFeedback('error', '✗', 'Erro de rede ao validar QR.'); 
                console.error('[FRONTEND] Erro de rede:', error);
            }
        }

        function startQrScanner() {
            if (!html5QrCode) { 
                alert("Erro: Leitor QR não inicializado."); 
                return; 
            }
            
            const qrScannerWrapper = document.getElementById('qrScannerWrapper');
            const msgContainer = document.getElementById('qrReaderMessageContainer');
            const startBtn = document.getElementById('startScanButton');
            const stopBtn = document.getElementById('stopScanButton');
            const textFeedback = document.getElementById('scanResultText');

            if (msgContainer) msgContainer.style.display = 'none';
            if (qrScannerWrapper) qrScannerWrapper.style.display = 'block';

            const videoConstraints = { facingMode: "environment" };
            const configScanner = {
                fps: 10,
                qrbox: (viewfinderWidth, viewfinderHeight) => {
                    let edgePercentage = 0.7;
                    let qrboxEdgeSize = Math.floor(Math.min(viewfinderWidth, viewfinderHeight) * edgePercentage);
                    qrboxEdgeSize = Math.max(150, qrboxEdgeSize);
                    qrboxEdgeSize = Math.min(300, qrboxEdgeSize);
                    return { width: qrboxEdgeSize, height: qrboxEdgeSize };
                },
                rememberLastUsedCamera: true,
                supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
            };

            if (html5QrCode.isScanning) { 
                console.log("Scanner já ativo."); 
                return; 
            }

            if (textFeedback) { 
                textFeedback.textContent = 'Iniciando câmera...'; 
                textFeedback.className = 'p-4 rounded-xl font-medium min-h-[3rem] flex items-center justify-center glass-effect text-blue-800 dark:text-blue-200';
            }

            html5QrCode.start(videoConstraints, configScanner, onScanSuccess, onScanFailure)
            .then(() => {
                if(startBtn) startBtn.style.display = 'none';
                if(stopBtn) stopBtn.style.display = 'inline-flex';
                if(textFeedback) { 
                    textFeedback.textContent = 'Câmera ativa. Aponte para QR Code.'; 
                    textFeedback.className = 'p-4 rounded-xl font-medium min-h-[3rem] flex items-center justify-center glass-effect text-green-800 dark:text-green-200'; 
                }
                console.log("Scanner iniciado.");
            }).catch(err => {
                let errorMsg = `Erro câmera: ${err}. Verifique HTTPS/permissões.`;
                if (String(err).includes("Requested camera not available")) {
                    errorMsg = "Câmera não encontrada ou não permitida. Verifique as permissões.";
                }
                if(textFeedback) { 
                    textFeedback.textContent = errorMsg; 
                    textFeedback.className = 'p-4 rounded-xl font-medium min-h-[3rem] flex items-center justify-center glass-effect text-red-800 dark:text-red-200'; 
                }
                if (msgContainer) msgContainer.style.display = 'block';
                if (qrScannerWrapper) qrScannerWrapper.style.display = 'none';
                if(startBtn) startBtn.style.display = 'inline-flex';
                if(stopBtn) stopBtn.style.display = 'none';
                console.error("Erro ao iniciar scanner:", err);
            });
        }

        async function stopQrScanner() {
            if (!html5QrCode || !html5QrCode.isScanning) {
                // Scanner not running
            } else {
                try { 
                    await html5QrCode.stop(); 
                    console.log("Scanner parado."); 
                }
                catch (err) { 
                    console.error("Erro ao tentar parar o scanner:", err); 
                }
            }
            
            const startBtn = document.getElementById('startScanButton');
            const stopBtn = document.getElementById('stopScanButton');
            const textFeedback = document.getElementById('scanResultText');
            const qrScannerWrapper = document.getElementById('qrScannerWrapper');
            const msgContainer = document.getElementById('qrReaderMessageContainer');
            const overlay = document.getElementById('scanOverlayFeedback');

            if(startBtn) startBtn.style.display = 'inline-flex';
            if(stopBtn) stopBtn.style.display = 'none';
            if (qrScannerWrapper) qrScannerWrapper.style.display = 'none';
            if (msgContainer) msgContainer.style.display = 'block';
            if (overlay) {
                overlay.classList.remove('visible', 'success-bg', 'error-bg', 'warning-bg', 'processing-bg');
            }
            if(textFeedback) {
                if (!textFeedback.className.includes('text-red-800')) {
                    textFeedback.textContent = 'Scanner parado.';
                    textFeedback.className = 'p-4 rounded-xl font-medium min-h-[3rem] flex items-center justify-center glass-effect text-gray-700 dark:text-gray-300';
                }
            }
        }
    </script>
</body>
</html>