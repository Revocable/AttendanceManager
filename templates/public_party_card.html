<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ party.name }} - Detalhes do Evento</title>

    <!-- Metatags OG para compartilhamento -->
    <meta property="og:title" content="{{ party.name }}">
    <meta property="og:description" content="{{ party.public_description or 'Detalhes do evento em QRPass.' }}">
    {% if party.logo_filename %}
    <meta property="og:image" content="{{ url_for('serve_persistent_file', filename='party_logos/' + party.logo_filename, _external=True) }}">
    {% endif %}
    <meta property="og:url" content="{{ url_for('public_party_page', shareable_link_id=party.shareable_link_id, _external=True) }}">
    <meta property="og:type" content="website">

    <!-- Scripts e Estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>

    <style>
        @font-face {
            font-family: 'Birthstone-Regular';
            src: url('{{ url_for('static', filename='fonts/Birthstone-Regular.ttf') }}') format('truetype');
        }
        @font-face {
            font-family: 'Ephesis-Regular';
            src: url('{{ url_for('static', filename='fonts/Ephesis-Regular.ttf') }}') format('truetype');
        }
        @font-face {
            font-family: 'Montserrat-Regular';
            src: url('{{ url_for('static', filename='fonts/Montserrat-Regular.ttf') }}') format('truetype');
        }
        @font-face {
            font-family: 'Radley-Regular';
            src: url('{{ url_for('static', filename='fonts/Radley-Regular.ttf') }}') format('truetype');
        }
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            '50': '#eff6ff', '100': '#dbeafe', '200': '#bfdbfe', '300': '#93c5fd', '400': '#60a5fa', '500': '#3b82f6', '600': '#2563eb', '700': '#1d4ed8', '800': '#1e40af', '900': '#1e3a8a',
                        },
                        secondary: {
                            '50': '#f0f9ff', '100': '#e0f2fe', '200': '#bae6fd', '300': '#7dd3fc', '400': '#38bdf8', '500': '#0ea5e9', '600': '#0284c7', '700': '#0369a1', '800': '#075985', '900': '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body, .bg-circle, #download-btn, .btn-action {
            transition: background-color 1s ease, background 1s ease, color 0.3s ease;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass-card {
            background: rgba(17, 24, 39, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen flex items-center justify-center p-4 text-gray-800 dark:text-gray-200 font-sans">
    
    <div class="fixed inset-0 overflow-hidden pointer-events-none -z-10">
        <div id="bg-circle-1" class="absolute -top-40 -right-40 w-80 h-80 bg-primary-300 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-3xl opacity-50 animate-pulse"></div>
        <div id="bg-circle-2" class="absolute -bottom-40 -left-40 w-80 h-80 bg-secondary-300 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-3xl opacity-50 animate-pulse animation-delay-2000"></div>
        <div id="bg-circle-3" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-indigo-300 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-3xl opacity-50 animate-pulse animation-delay-4000"></div>
    </div>

    <main class="w-full max-w-lg mx-auto">
        <div id="invitation-card" class="glass-card rounded-3xl shadow-2xl overflow-hidden">
            
            {% if party.logo_filename %}
            <div id="image-container" class="w-full h-48 bg-gray-200 dark:bg-gray-800">
                 <img id="party-logo-image" src="{{ url_for('serve_persistent_file', filename='party_logos/' + party.logo_filename) }}" 
                     alt="Logo do Evento" 
                     class="w-full h-full object-cover"
                     crossorigin="anonymous">
            </div>
            {% endif %}

            <div class="p-6 sm:p-8">
                <h1 class="text-4xl font-extrabold text-gray-900 dark:text-white tracking-tight text-center" style="font-family: '{{ party.invite_font if party.invite_font else 'Montserrat-Regular' }}', sans-serif;">{{ party.name }}</h1>
                
                <div class="mt-8 space-y-5 text-left border-t border-gray-200 dark:border-gray-700/50 pt-6">
                    
                    {% if party.event_date %}
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-8 text-center pt-1">
                            <i class="fas fa-calendar-alt fa-fw text-primary-500 dark:text-primary-400 text-lg"></i>
                        </div>
                        <div class="flex-1 ml-4">
                            <p class="font-semibold text-gray-800 dark:text-gray-100">
                                {{ party.event_date.strftime('%d/%m/%Y') if party.event_date else 'Data a confirmar' }}
                                {% if party.event_time %}
                                    às {{ party.event_time.strftime('%H:%M') }}
                                {% endif %}
                            </p>
                            <p id="countdown" class="text-sm text-gray-600 dark:text-gray-400">Calculando...</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if party.location %}
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-8 text-center pt-1">
                             <i class="fas fa-map-marker-alt fa-fw text-primary-500 dark:text-primary-400 text-lg"></i>
                        </div>
                        <div class="flex-1 ml-4">
                            <a href="{{ generate_google_maps_url(party.location) }}" target="_blank" class="font-semibold text-gray-800 dark:text-gray-100 hover:underline">
                                {{ party.location }}
                            </a>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Clique para abrir no mapa</p>
                        </div>
                    </div>
                    {% endif %}

                    {% if party.show_guest_count %}
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-8 text-center pt-1">
                            <i class="fas fa-users fa-fw text-primary-500 dark:text-primary-400 text-lg"></i>
                        </div>
                        <div class="flex-1 ml-4">
                            <p class="font-semibold text-gray-800 dark:text-gray-100">{{ stats.total_invited }} Convidados</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Confirmados na lista do evento.</p>
                        </div>
                    </div>
                    {% endif %}
                </div>

                {% if party.public_description %}
                <div class="mt-6 border-t border-gray-200 dark:border-gray-700/50 pt-6">
                    <p class="text-gray-600 dark:text-gray-300 whitespace-pre-wrap">{{ party.public_description }}</p>
                </div>
                {% endif %}

                <!-- CORREÇÃO FINAL: Adicionado 'text-base' para aumentar o tamanho da fonte e melhorar o alinhamento vertical -->
                {% if party.ticket_price > 0 and party.allow_public_purchase %}
                <div class="mt-8 text-center">
                    <a href="{{ url_for('buy_ticket_public', party_id=party.id) }}" 
                       class="btn-action bg-gradient-to-r from-green-500 to-teal-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 inline-flex items-center justify-center space-x-2 text-base">
                        <i class="fas fa-ticket-alt"></i>
                        <span>Comprar Ingresso (R$ {{ '%.2f' | format(party.ticket_price) }})</span>
                    </a>
                </div>
                {% elif party.ticket_price == 0 and party.allow_public_purchase %}
                <div class="mt-8 text-center">
                    <a href="{{ url_for('buy_ticket_public', party_id=party.id) }}" 
                       class="btn-action bg-gradient-to-r from-green-500 to-teal-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 inline-flex items-center justify-center space-x-2 text-base">
                        <i class="fas fa-ticket-alt"></i>
                        <span>Obter Ingresso Gratuito</span>
                    </a>
                </div>
                {% elif party.ticket_price > 0 and not party.allow_public_purchase %}
                <div class="mt-8 p-4 bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-200 rounded-lg text-center">
                    <p class="font-semibold">Ingressos por convite direto.</p>
                    <p class="text-sm">Preço do ingresso: R$ {{ '%.2f' | format(party.ticket_price) }}</p>
                </div>
                {% endif %}

            </div>
        </div>

        <!-- CORREÇÃO FINAL: Adicionado 'text-base' para consistência visual -->
        <div class="mt-6 text-center">
            <button id="download-btn" class="btn-action bg-primary-600 hover:bg-primary-700 dark:bg-primary-500 dark:hover:bg-primary-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 w-52 text-base">
                <i class="fas fa-download mr-2"></i>
                Salvar Convite
            </button>
        </div>
        
        <footer class="text-center mt-6">
            <a id="footer-link" href="{{ url_for('landing') }}" class="text-sm text-gray-500 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors">
                Criado com <strong>QRPass</strong>
            </a>
        </footer>
    </main>
    
    <style id="dynamic-theme-styles"></style>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const downloadButton = document.getElementById('download-btn');
            const invitationCard = document.getElementById('invitation-card');
            
            downloadButton.addEventListener('click', () => {
                downloadButton.disabled = true;
                downloadButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';
                
                const cardToRender = invitationCard.cloneNode(true);
                
                const imageContainer = cardToRender.querySelector('#image-container');
                const imageElement = cardToRender.querySelector('#party-logo-image');
                if (imageContainer && imageElement) {
                    imageContainer.style.backgroundImage = `url(${imageElement.src})`;
                    imageContainer.style.backgroundSize = 'cover';
                    imageContainer.style.backgroundPosition = 'center';
                    imageElement.remove();
                }

                cardToRender.style.position = 'absolute';
                cardToRender.style.left = '-9999px';
                cardToRender.style.top = '0px';
                cardToRender.style.width = invitationCard.offsetWidth + 'px'; 

                document.body.appendChild(cardToRender);

                html2canvas(cardToRender, { 
                    useCORS: true, 
                    scale: 3,
                    logging: false,
                    allowTaint: true,
                    backgroundColor: null 
                }).then(canvas => {
                    const link = document.createElement('a');
                    const partyName = "{{ party.name }}".replace(/[^a-z0-9]/gi, '_').toLowerCase();
                    link.download = `convite_${partyName || 'festa'}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                }).catch(error => {
                    console.error('Erro ao gerar imagem:', error);
                    alert('Não foi possível salvar o convite. Tente novamente.');
                }).finally(() => {
                    document.body.removeChild(cardToRender);
                    downloadButton.disabled = false;
                    downloadButton.innerHTML = '<i class="fas fa-download mr-2"></i>Salvar Convite';
                });
            });

            // Contador Regressivo (Lógica mantida)
            const countdownElement = document.getElementById('countdown');
            const eventDateStr = "{{ party.event_date.isoformat() if party.event_date else '' }}";
            const eventTimeStr = "{{ party.event_time.strftime('%H:%M:%S') if party.event_time else '00:00:00' }}";

            if (countdownElement && eventDateStr) {
                const eventDateTime = new Date(`${eventDateStr}T${eventTimeStr}`);

                const updateCountdown = () => {
                    const now = new Date().getTime();
                    const distance = eventDateTime - now;

                    if (distance < 0) {
                        countdownElement.textContent = "O evento já começou!";
                        if (window.countdownInterval) clearInterval(window.countdownInterval);
                        return;
                    }

                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    countdownElement.textContent = `Faltam ${days}d ${hours}h ${minutes}m ${seconds}s`;
                };

                updateCountdown();
                window.countdownInterval = setInterval(updateCountdown, 1000);
            } else if (countdownElement) {
                countdownElement.style.display = 'none';
            }
        });
    </script>
    
    <script>
        // Script de Tema Dinâmico (Lógica mantida)
        document.addEventListener('DOMContentLoaded', () => {
            const partyImage = document.getElementById('party-logo-image');
            if (!partyImage) return;

            const colorThief = new ColorThief();
            const toRgbString = (rgbArray) => `rgb(${rgbArray.join(',')})`;
            const getLuminance = (rgb) => 0.299 * rgb[0] + 0.587 * rgb[1] + 0.114 * rgb[2];

            const applyDynamicTheme = () => {
                try {
                    const palette = colorThief.getPalette(partyImage, 8);
                    if (!palette || palette.length < 5) return;

                    palette.sort((a, b) => getLuminance(b) - getLuminance(a));

                    const primaryColor = toRgbString(palette[1]);
                    const secondaryColor = toRgbString(palette[3]); 
                    const accentColor = toRgbString(palette[4]);
                    
                    const lightBgStart = toRgbString(palette[0]);
                    const lightBgEnd = `rgb(${palette[0].map(c => Math.max(0, c - 20)).join(',')})`;

                    const darkBgStart = toRgbString(palette[palette.length - 1]);
                    const darkBgEnd = `rgb(${palette[palette.length - 1].map(c => Math.min(255, c + 20)).join(',')})`;

                    const dynamicStyles = `
                        body { background: linear-gradient(to bottom right, ${lightBgStart}, ${lightBgEnd}); }
                        .dark body { background: linear-gradient(to bottom right, ${darkBgStart}, ${darkBgEnd}); }
                        #bg-circle-1 { background-color: ${primaryColor}; }
                        #bg-circle-2 { background-color: ${secondaryColor}; }
                        #bg-circle-3 { background-color: ${accentColor}; }
                        .text-primary-500 { color: ${primaryColor} !important; }
                        .text-primary-600 { color: ${primaryColor} !important; }
                        .dark .text-primary-400 { color: ${secondaryColor} !important; }
                        #download-btn { background: ${primaryColor}; }
                        #download-btn:hover { background: ${secondaryColor}; }
                        #footer-link:hover { color: ${primaryColor} !important; }
                        .dark #footer-link:hover { color: ${secondaryColor} !important; }
                        .btn-action.bg-gradient-to-r { background-image: linear-gradient(to right, ${primaryColor}, ${secondaryColor}) !important; }
                    `;
                    document.getElementById('dynamic-theme-styles').innerHTML = dynamicStyles;
                } catch (error) {
                    console.error("Erro ao aplicar tema dinâmico:", error);
                }
            };

            if (partyImage.complete && partyImage.naturalHeight !== 0) {
                applyDynamicTheme();
            } else {
                partyImage.addEventListener('load', applyDynamicTheme);
            }
        });
    </script>
</body>
</html>